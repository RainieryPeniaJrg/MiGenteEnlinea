@{
    ViewData["Title"] = "Calificaciones de Perfiles";
    Layout = "~/Views/Shared/_LayoutEmpleador.cshtml";
}

<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/Empleador/Colaboradores">Inicio</a></li>
            <li class="breadcrumb-item active">Calificación de Perfiles</li>
        </ol>
    </nav>

    <!-- Page Title -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold">
                <i class="bi bi-star-fill text-warning me-2"></i>Consulta y Califica Perfiles
            </h2>
        </div>
    </div>

    <!-- Intro Cards -->
    <div class="row mb-4">
        <!-- Card: Calificar Perfil -->
        <div class="col-md-6">
            <div class="card border-primary h-100">
                <div class="card-body text-center">
                    <i class="bi bi-star fs-1 text-warning mb-3"></i>
                    <h5 class="card-title fw-bold">Calificar Perfil</h5>
                    <p class="card-text">
                        Califica el perfil de tus colaboradores que ya no están activos en tu nómina.
                    </p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCalificar">
                        <i class="bi bi-pencil-square me-2"></i>Calificar
                    </button>
                </div>
            </div>
        </div>

        <!-- Card: Consultar Perfiles -->
        <div class="col-md-6">
            <div class="card border-info h-100">
                <div class="card-body text-center">
                    <i class="bi bi-search fs-1 text-info mb-3"></i>
                    <h5 class="card-title fw-bold">Consultar Perfiles</h5>
                    <p class="card-text">
                        Consulta las calificaciones de cualquier perfil en la plataforma.
                    </p>
                    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalConsultarPerfil">
                        <i class="bi bi-person-lines-fill me-2"></i>Consultar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Section: Mis Calificaciones -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-list-stars me-2"></i>Mis Calificaciones
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Search Input -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" id="searchCalificaciones" class="form-control" 
                                   placeholder="Buscar por identificación o nombre..." 
                                   onkeyup="filtrarCalificaciones()">
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tablaCalificaciones">
                            <thead class="table-dark">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Identificación</th>
                                    <th>Nombre</th>
                                    <th class="text-center">Puntualidad</th>
                                    <th class="text-center">Cumplimiento</th>
                                    <th class="text-center">Conocimientos</th>
                                    <th class="text-center">Recomendación</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyCalificaciones">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        Cargando calificaciones...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- No Results Message -->
                    <div id="noResultsMessage" class="alert alert-info text-center d-none">
                        <i class="bi bi-info-circle me-2"></i>
                        No has realizado ninguna calificación todavía.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Calificar Perfil -->
<div class="modal fade" id="modalCalificar" tabindex="-1" aria-labelledby="modalCalificarLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalCalificarLabel">
                    <i class="bi bi-star-fill me-2"></i>Calificar Perfil
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCalificar">
                    <!-- Select Profile -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Seleccionar Perfil a Calificar</label>
                        <select class="form-select" id="ddlPerfil" onchange="seleccionarPerfil()">
                            <option value="">-- Seleccione un colaborador --</option>
                        </select>
                        <small class="text-muted">Solo se muestran colaboradores que ya no están activos en tu nómina</small>
                    </div>

                    <!-- Identificación (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">RNC/Cédula</label>
                        <input type="text" class="form-control" id="calif_identificacion" readonly>
                    </div>

                    <!-- Nombre (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nombre Completo</label>
                        <input type="text" class="form-control" id="calif_nombre" readonly>
                    </div>

                    <hr>

                    <!-- Rating: Puntualidad -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Puntualidad</label>
                        <div class="star-rating" data-rating="0" data-field="puntualidad">
                            <i class="bi bi-star star-icon" data-value="1"></i>
                            <i class="bi bi-star star-icon" data-value="2"></i>
                            <i class="bi bi-star star-icon" data-value="3"></i>
                            <i class="bi bi-star star-icon" data-value="4"></i>
                            <i class="bi bi-star star-icon" data-value="5"></i>
                        </div>
                        <input type="hidden" id="rating_puntualidad" value="0">
                    </div>

                    <!-- Rating: Cumplimiento -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Cumplimiento</label>
                        <div class="star-rating" data-rating="0" data-field="cumplimiento">
                            <i class="bi bi-star star-icon" data-value="1"></i>
                            <i class="bi bi-star star-icon" data-value="2"></i>
                            <i class="bi bi-star star-icon" data-value="3"></i>
                            <i class="bi bi-star star-icon" data-value="4"></i>
                            <i class="bi bi-star star-icon" data-value="5"></i>
                        </div>
                        <input type="hidden" id="rating_cumplimiento" value="0">
                    </div>

                    <!-- Rating: Conocimientos -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Conocimientos Técnicos</label>
                        <div class="star-rating" data-rating="0" data-field="conocimientos">
                            <i class="bi bi-star star-icon" data-value="1"></i>
                            <i class="bi bi-star star-icon" data-value="2"></i>
                            <i class="bi bi-star star-icon" data-value="3"></i>
                            <i class="bi bi-star star-icon" data-value="4"></i>
                            <i class="bi bi-star star-icon" data-value="5"></i>
                        </div>
                        <input type="hidden" id="rating_conocimientos" value="0">
                    </div>

                    <!-- Rating: Recomendación -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">¿Lo recomendarías?</label>
                        <div class="star-rating" data-rating="0" data-field="recomendacion">
                            <i class="bi bi-star star-icon" data-value="1"></i>
                            <i class="bi bi-star star-icon" data-value="2"></i>
                            <i class="bi bi-star star-icon" data-value="3"></i>
                            <i class="bi bi-star star-icon" data-value="4"></i>
                            <i class="bi bi-star star-icon" data-value="5"></i>
                        </div>
                        <input type="hidden" id="rating_recomendacion" value="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarCalificacion()" id="btnCalificar" disabled>
                    <i class="bi bi-check-circle me-2"></i>Calificar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Consultar Perfil -->
<div class="modal fade" id="modalConsultarPerfil" tabindex="-1" aria-labelledby="modalConsultarPerfilLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalConsultarPerfilLabel">
                    <i class="bi bi-search me-2"></i>Consultar Perfil
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Ingrese RNC o Cédula</label>
                    <input type="text" class="form-control" id="txtIdentificacion" 
                           placeholder="Ej: 001-1234567-8">
                    <small class="text-muted">Ingrese la identificación del perfil que desea consultar</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-info" onclick="consultarPerfil()">
                    <i class="bi bi-search me-2"></i>Buscar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Perfil Encontrado -->
<div class="modal fade" id="modalPerfilEncontrado" tabindex="-1" aria-labelledby="modalPerfilEncontradoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalPerfilEncontradoLabel">
                    <i class="bi bi-person-check-fill me-2"></i>Perfil Encontrado
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted">Identificación</label>
                        <p class="fw-bold" id="perfil_identificacion">-</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted">Nombre</label>
                        <p class="fw-bold" id="perfil_nombre">-</p>
                    </div>
                </div>

                <hr>

                <h6 class="fw-bold mb-3">Calificaciones Promedio</h6>

                <!-- Puntualidad Promedio -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted">Puntualidad</label>
                    </div>
                    <div class="col-md-6 text-end" id="perfil_puntualidad">
                        <!-- Stars rendered dynamically -->
                    </div>
                </div>

                <!-- Cumplimiento Promedio -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted">Cumplimiento</label>
                    </div>
                    <div class="col-md-6 text-end" id="perfil_cumplimiento">
                        <!-- Stars rendered dynamically -->
                    </div>
                </div>

                <!-- Conocimientos Promedio -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted">Conocimientos</label>
                    </div>
                    <div class="col-md-6 text-end" id="perfil_conocimientos">
                        <!-- Stars rendered dynamically -->
                    </div>
                </div>

                <!-- Recomendación Promedio -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted">Recomendación</label>
                    </div>
                    <div class="col-md-6 text-end" id="perfil_recomendacion">
                        <!-- Stars rendered dynamically -->
                    </div>
                </div>

                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Total de calificaciones:</strong> <span id="perfil_total_calificaciones">0</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Star Rating Component */
    .star-rating {
        font-size: 2rem;
        cursor: pointer;
        display: inline-block;
    }

    .star-rating .star-icon {
        color: #ddd;
        transition: color 0.2s ease;
        cursor: pointer;
    }

    .star-rating .star-icon:hover,
    .star-rating .star-icon.hover {
        color: gold;
    }

    .star-rating .star-icon.filled {
        color: gold;
    }

    /* Display Stars (read-only in table) */
    .display-stars {
        color: gold;
        font-size: 1.1rem;
    }

    /* Card hover effect */
    .card:hover {
        transform: translateY(-5px);
        transition: transform 0.3s ease;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
</style>

@section Scripts {
    <script>
        let misCalificaciones = [];
        let perfilesParaCalificar = [];

        $(document).ready(function () {
            cargarMisCalificaciones();
            inicializarStarRating();
        });

        // ========== LOAD DATA ==========
        function cargarMisCalificaciones() {
            $.ajax({
                url: '/Empleador/GetMisCalificaciones',
                type: 'GET',
                success: function (response) {
                    if (response.success) {
                        misCalificaciones = response.data;
                        renderizarCalificaciones();
                    } else {
                        mostrarError('Error al cargar calificaciones');
                    }
                },
                error: function () {
                    mostrarError('Error de conexión al cargar calificaciones');
                }
            });
        }

        function cargarPerfilesParaCalificar() {
            $.ajax({
                url: '/Empleador/GetPerfilesParaCalificar',
                type: 'GET',
                success: function (response) {
                    if (response.success) {
                        perfilesParaCalificar = response.data;
                        renderizarDropdownPerfiles();
                    } else {
                        mostrarError('Error al cargar perfiles');
                    }
                },
                error: function () {
                    mostrarError('Error de conexión al cargar perfiles');
                }
            });
        }

        // ========== RENDER FUNCTIONS ==========
        function renderizarCalificaciones() {
            const tbody = $('#tbodyCalificaciones');
            tbody.empty();

            if (misCalificaciones.length === 0) {
                $('#noResultsMessage').removeClass('d-none');
                tbody.append(`
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            No hay calificaciones para mostrar
                        </td>
                    </tr>
                `);
                return;
            }

            $('#noResultsMessage').addClass('d-none');

            misCalificaciones.forEach(calif => {
                const row = `
                    <tr>
                        <td>${formatearFecha(calif.fecha)}</td>
                        <td>${calif.identificacion}</td>
                        <td>${calif.nombre}</td>
                        <td class="text-center">${renderStars(calif.puntualidad)}</td>
                        <td class="text-center">${renderStars(calif.cumplimiento)}</td>
                        <td class="text-center">${renderStars(calif.conocimientos)}</td>
                        <td class="text-center">${renderStars(calif.recomendacion)}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function renderizarDropdownPerfiles() {
            const select = $('#ddlPerfil');
            select.empty();
            select.append('<option value="">-- Seleccione un colaborador --</option>');

            perfilesParaCalificar.forEach(perfil => {
                select.append(`<option value="${perfil.identificacion}" data-nombre="${perfil.nombre}" data-tipo="${perfil.tipo}">${perfil.nombre}</option>`);
            });
        }

        function renderStars(rating) {
            let stars = '';
            const numRating = Math.round(parseFloat(rating));
            for (let i = 0; i < numRating; i++) {
                stars += '<i class="bi bi-star-fill display-stars"></i> ';
            }
            return stars;
        }

        // ========== STAR RATING COMPONENT ==========
        function inicializarStarRating() {
            $('.star-rating .star-icon').on('click', function () {
                const rating = $(this).data('value');
                const container = $(this).closest('.star-rating');
                const field = container.data('field');

                // Update hidden input
                $(`#rating_${field}`).val(rating);

                // Update visual state
                container.data('rating', rating);
                actualizarStars(container, rating);
            });

            $('.star-rating .star-icon').on('mouseenter', function () {
                const rating = $(this).data('value');
                const container = $(this).closest('.star-rating');
                actualizarStars(container, rating);
            });

            $('.star-rating').on('mouseleave', function () {
                const currentRating = $(this).data('rating');
                actualizarStars($(this), currentRating);
            });
        }

        function actualizarStars(container, rating) {
            container.find('.star-icon').each(function () {
                const value = $(this).data('value');
                if (value <= rating) {
                    $(this).removeClass('bi-star').addClass('bi-star-fill filled');
                } else {
                    $(this).removeClass('bi-star-fill filled').addClass('bi-star');
                }
            });
        }

        function resetStarRatings() {
            $('.star-rating').each(function () {
                $(this).data('rating', 0);
                actualizarStars($(this), 0);
            });
            $('input[id^="rating_"]').val(0);
        }

        // ========== MODAL EVENTS ==========
        $('#modalCalificar').on('show.bs.modal', function () {
            cargarPerfilesParaCalificar();
            resetFormCalificar();
        });

        function resetFormCalificar() {
            $('#ddlPerfil').val('');
            $('#calif_identificacion').val('');
            $('#calif_nombre').val('');
            resetStarRatings();
            $('#btnCalificar').prop('disabled', true);
        }

        function seleccionarPerfil() {
            const select = $('#ddlPerfil');
            const selectedOption = select.find('option:selected');

            if (select.val() !== '') {
                $('#calif_identificacion').val(selectedOption.val());
                $('#calif_nombre').val(selectedOption.data('nombre'));
                $('#btnCalificar').prop('disabled', false);
            } else {
                $('#calif_identificacion').val('');
                $('#calif_nombre').val('');
                $('#btnCalificar').prop('disabled', true);
            }
        }

        // ========== CALIFICAR ACTION ==========
        function confirmarCalificacion() {
            const identificacion = $('#calif_identificacion').val();
            const nombre = $('#calif_nombre').val();
            const puntualidad = parseInt($('#rating_puntualidad').val());
            const cumplimiento = parseInt($('#rating_cumplimiento').val());
            const conocimientos = parseInt($('#rating_conocimientos').val());
            const recomendacion = parseInt($('#rating_recomendacion').val());

            // Validation
            if (!identificacion || !nombre) {
                mostrarAdvertencia('Debe seleccionar un perfil para calificar');
                return;
            }

            if (puntualidad === 0 || cumplimiento === 0 || conocimientos === 0 || recomendacion === 0) {
                mostrarAdvertencia('Debe completar todas las calificaciones (mínimo 1 estrella en cada categoría)');
                return;
            }

            // Confirm
            Swal.fire({
                title: '¿Confirmar calificación?',
                html: `
                    <p>Está a punto de calificar a:</p>
                    <p class="fw-bold">${nombre}</p>
                    <p class="text-muted small">Esta acción no se puede deshacer</p>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, calificar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#0d6efd'
            }).then((result) => {
                if (result.isConfirmed) {
                    enviarCalificacion(identificacion, nombre, puntualidad, cumplimiento, conocimientos, recomendacion);
                }
            });
        }

        function enviarCalificacion(identificacion, nombre, puntualidad, cumplimiento, conocimientos, recomendacion) {
            const selectedOption = $('#ddlPerfil').find('option:selected');
            const tipo = selectedOption.data('tipo') || 1;

            const request = {
                tipo: tipo,
                identificacion: identificacion,
                nombre: nombre,
                puntualidad: puntualidad,
                cumplimiento: cumplimiento,
                conocimientos: conocimientos,
                recomendacion: recomendacion
            };

            $.ajax({
                url: '/Empleador/CalificarPerfil',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(request),
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: '¡Calificación guardada!',
                            text: 'La calificación se ha registrado exitosamente',
                            confirmButtonText: 'Aceptar'
                        }).then(() => {
                            $('#modalCalificar').modal('hide');
                            cargarMisCalificaciones();
                        });
                    } else {
                        mostrarAdvertencia(response.message || 'No se pudo guardar la calificación');
                    }
                },
                error: function () {
                    mostrarError('Error de conexión al guardar calificación');
                }
            });
        }

        // ========== CONSULTAR PERFIL ==========
        function consultarPerfil() {
            const identificacion = $('#txtIdentificacion').val().trim();

            if (!identificacion) {
                mostrarAdvertencia('Debe ingresar una identificación (RNC o Cédula)');
                return;
            }

            $.ajax({
                url: '/Empleador/ConsultarPerfil',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ identificacion: identificacion }),
                success: function (response) {
                    if (response.success && response.data) {
                        mostrarPerfilEncontrado(response.data);
                        $('#modalConsultarPerfil').modal('hide');
                    } else {
                        mostrarAdvertencia('No se encontró ningún perfil con esa identificación');
                    }
                },
                error: function () {
                    mostrarError('Error de conexión al consultar perfil');
                }
            });
        }

        function mostrarPerfilEncontrado(perfil) {
            $('#perfil_identificacion').text(perfil.identificacion);
            $('#perfil_nombre').text(perfil.nombre);
            $('#perfil_puntualidad').html(renderStars(perfil.puntualidad));
            $('#perfil_cumplimiento').html(renderStars(perfil.cumplimiento));
            $('#perfil_conocimientos').html(renderStars(perfil.conocimientos));
            $('#perfil_recomendacion').html(renderStars(perfil.recomendacion));
            $('#perfil_total_calificaciones').text(perfil.totalCalificaciones || 0);

            $('#modalPerfilEncontrado').modal('show');
        }

        // ========== SEARCH/FILTER ==========
        function filtrarCalificaciones() {
            const searchTerm = $('#searchCalificaciones').val().toLowerCase();

            $('#tablaCalificaciones tbody tr').each(function () {
                const identificacion = $(this).find('td:eq(1)').text().toLowerCase();
                const nombre = $(this).find('td:eq(2)').text().toLowerCase();

                if (identificacion.includes(searchTerm) || nombre.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }

        // ========== UTILITIES ==========
        function formatearFecha(fechaStr) {
            const fecha = new Date(fechaStr);
            const dia = String(fecha.getDate()).padStart(2, '0');
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const anio = fecha.getFullYear();
            return `${dia}/${mes}/${anio}`;
        }

        function mostrarExito(mensaje) {
            Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: mensaje,
                confirmButtonText: 'Aceptar'
            });
        }

        function mostrarError(mensaje) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: mensaje,
                confirmButtonText: 'Aceptar'
            });
        }

        function mostrarAdvertencia(mensaje) {
            Swal.fire({
                icon: 'warning',
                title: 'Atención',
                text: mensaje,
                confirmButtonText: 'Aceptar'
            });
        }
    </script>
}
