@{
    ViewData["Title"] = "Gestión de Colaboradores";
}

<div class="pagetitle">
    <h1>Gestión de Colaboradores</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">Colaboradores</a></li>
        </ol>
    </nav>
</div>

<!-- Toast Alert -->
<div aria-live="polite" aria-atomic="true" class="position-relative">
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
        <div id="alertToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="min-width: 300px; background-color: #f8d7da; border-color: #f5c6cb; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
            <div class="toast-header" style="background-color: #f5c6cb;">
                <strong class="me-auto text-danger">¡Atención!</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body text-danger">
                Los campos marcados con * son obligatorios
            </div>
        </div>
    </div>
</div>

<!-- Botones de Acción -->
<div class="row bg-white p-3">
    <div class="col col-md-3 col-12">
        <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#modalTipoColaborador">
            <i class="bi bi-plus-circle"></i> Registrar Nuevo
        </button>
    </div>
    <div class="col col-md-3 col-12">
        <a href="@Url.Action("Consultar", "Comunidad")" class="btn btn-outline-success w-100">
            <i class="bi bi-people"></i> Consultar Comunidad
        </a>
    </div>
</div>

<hr />

<!-- Tabs Principales: Empleados Fijos vs Contrataciones Temporales -->
<ul class="nav nav-pills mb-3 mt-3" id="pills-tab1" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="pills-fijos-tab" data-bs-toggle="pill" data-bs-target="#pills-fijos" type="button" role="tab" aria-controls="pills-fijos" aria-selected="true">
            Empleados Fijos
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-temp-tab" data-bs-toggle="pill" data-bs-target="#pills-temp" type="button" role="tab" aria-controls="pills-temp" aria-selected="false">
            Contrataciones Temporales
        </button>
    </li>
</ul>

<div class="tab-content" id="pills-tabContent1">
    
    <!-- ============= TAB 1: EMPLEADOS FIJOS ============= -->
    <div class="tab-pane fade show active" id="pills-fijos" role="tabpanel" aria-labelledby="pills-fijos-tab">
        <hr />
        
        <!-- Sub-tabs: Activos vs Historial -->
        <ul class="nav nav-pills mb-3 mt-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-active-tab" data-bs-toggle="pill" data-bs-target="#pills-active" type="button" role="tab" aria-controls="pills-active" aria-selected="true">
                    Colaboradores Activos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-inact-tab" data-bs-toggle="pill" data-bs-target="#pills-inact" type="button" role="tab" aria-controls="pills-inact" aria-selected="false">
                    Historial
                </button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            
            <!-- Sub-tab: Empleados Activos -->
            <div class="tab-pane fade show active" id="pills-active" role="tabpanel" aria-labelledby="pills-active-tab">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card" style="overflow: auto; white-space: nowrap">
                            <div class="card-body">
                                <h5 class="card-title">Administra tus Colaboradores</h5>

                                <div class="datatable-wrapper datatable-loading no-footer sortable searchable fixed-columns" style="min-height: 300px">
                                    <input type="text" id="search" class="form-control mb-3" placeholder="Buscar...">

                                    <div class="datatable-container">
                                        <table class="table datatable">
                                            <thead>
                                                <tr>
                                                    <th>Foto</th>
                                                    <th>Acciones</th>
                                                    <th>Fecha Inicio</th>
                                                    <th>Identificación</th>
                                                    <th>Nombre</th>
                                                    <th>Salario</th>
                                                </tr>
                                            </thead>
                                            <tbody id="colaboradoresTableBody">
                                                <tr id="loadingRow">
                                                    <td colspan="6" class="text-center">
                                                        <div class="spinner-border" role="status">
                                                            <span class="visually-hidden">Cargando...</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Empleados Inactivos (Historial) -->
            <div class="tab-pane fade" id="pills-inact" role="tabpanel" aria-labelledby="pills-inact-tab">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card" style="overflow: auto; white-space: nowrap">
                            <div class="card-body">
                                <h5 class="card-title" style="color: darkred">Colaboradores Inactivos</h5>

                                <div class="datatable-wrapper datatable-loading no-footer sortable searchable fixed-columns" style="min-height: 300px">
                                    <input type="text" id="search2" class="form-control mb-3" placeholder="Buscar...">

                                    <div class="datatable-container">
                                        <table class="table datatable">
                                            <thead>
                                                <tr>
                                                    <th>Foto</th>
                                                    <th>Acciones</th>
                                                    <th>Fecha Inicio</th>
                                                    <th>Fecha Salida</th>
                                                    <th>Identificación</th>
                                                    <th>Nombre</th>
                                                    <th>Salario</th>
                                                </tr>
                                            </thead>
                                            <tbody id="colaboradoresInactivosTableBody">
                                                <tr id="loadingRow2">
                                                    <td colspan="7" class="text-center">
                                                        <div class="spinner-border" role="status">
                                                            <span class="visually-hidden">Cargando...</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============= TAB 2: CONTRATACIONES TEMPORALES ============= -->
    <div class="tab-pane fade" id="pills-temp" role="tabpanel" aria-labelledby="pills-temp-tab">
        
        <!-- Sub-tabs: En Curso vs Historial -->
        <ul class="nav nav-pills mb-3 mt-3" id="pills-tab2" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-contr-tab" data-bs-toggle="pill" data-bs-target="#pills-contr" type="button" role="tab" aria-controls="pills-contr" aria-selected="true">
                    Contratos en Curso
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-contrH-tab" data-bs-toggle="pill" data-bs-target="#pills-contrH" type="button" role="tab" aria-controls="pills-contrH" aria-selected="false">
                    Historial
                </button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent2">
            
            <!-- Sub-tab: Contrataciones Activas -->
            <div class="tab-pane fade show active" id="pills-contr" role="tabpanel" aria-labelledby="pills-contr-tab">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card" style="overflow: auto; white-space: nowrap">
                            <div class="card-body">
                                <h5 class="card-title">Gestión de Contrataciones Temporales</h5>
                                <label>
                                    Registrar y gestiona la contratación de servicios de una manera centralizada y simple.
                                </label>
                                <hr />

                                <div class="datatable-wrapper datatable-loading no-footer sortable searchable fixed-columns" style="min-height: 300px">
                                    <input type="text" id="search3" class="form-control mb-3" placeholder="Buscar...">

                                    <div class="datatable-container">
                                        <table class="table datatable">
                                            <thead>
                                                <tr>
                                                    <th>Foto</th>
                                                    <th>Acciones</th>
                                                    <th>Fecha Registro</th>
                                                    <th>Nombre</th>
                                                    <th>RNC/Cédula</th>
                                                    <th>Teléfono 1</th>
                                                    <th>Teléfono 2</th>
                                                </tr>
                                            </thead>
                                            <tbody id="colaboradoresTempTableBody">
                                                <tr id="loadingRow3">
                                                    <td colspan="7" class="text-center">
                                                        <div class="spinner-border" role="status">
                                                            <span class="visually-hidden">Cargando...</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Contrataciones Historial -->
            <div class="tab-pane fade" id="pills-contrH" role="tabpanel" aria-labelledby="pills-contrH-tab">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card" style="overflow: auto; white-space: nowrap">
                            <div class="card-body">
                                <h5 class="card-title">Historial de Contrataciones Temporales</h5>
                                <label>
                                    Gestiona tu histórico de servicios de una manera centralizada y simple.
                                </label>
                                <hr />

                                <div class="datatable-wrapper datatable-loading no-footer sortable searchable fixed-columns" style="min-height: 300px">
                                    <input type="text" id="search4" class="form-control mb-3" placeholder="Buscar...">

                                    <div class="datatable-container">
                                        <table class="table datatable">
                                            <thead>
                                                <tr>
                                                    <th>Foto</th>
                                                    <th>Acciones</th>
                                                    <th>Fecha Registro</th>
                                                    <th>Nombre</th>
                                                    <th>RNC/Cédula</th>
                                                    <th>Teléfono 1</th>
                                                    <th>Teléfono 2</th>
                                                </tr>
                                            </thead>
                                            <tbody id="colaboradoresTempHTableBody">
                                                <tr id="loadingRow4">
                                                    <td colspan="7" class="text-center">
                                                        <div class="spinner-border" role="status">
                                                            <span class="visually-hidden">Cargando...</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Selección de Tipo de Colaborador -->
<div class="modal fade" id="modalTipoColaborador" tabindex="-1" aria-labelledby="modalTipoColaboradorLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTipoColaboradorLabel">Tipo de Contratación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="selectTipoColaborador" class="form-label">Seleccione el tipo:</label>
                    <select id="selectTipoColaborador" class="form-select">
                        <option value="1" selected>Empleado Fijo</option>
                        <option value="2">Contratista Temporal</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnComenzar">
                    <i class="bi bi-check"></i> Comenzar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
$(document).ready(function () {
    var pageIndex = 1;
    var pageSize = 10;

    // ========== FUNCIONES PARA EMPLEADOS FIJOS ACTIVOS ==========
    function loadColaboradores(pageIndex, searchTerm) {
        $("#loadingRow").show();
        
        $.ajax({
            type: "POST",
            url: "@Url.Action("GetColaboradores", "Empleador")",
            data: JSON.stringify({ 
                pageIndex: pageIndex, 
                pageSize: pageSize, 
                searchTerm: searchTerm 
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                var colaboradores = response.colaboradores;
                var totalRecords = response.totalRecords;

                // Limpiar la tabla
                $("#colaboradoresTableBody").empty();

                if (colaboradores.length === 0) {
                    $("#colaboradoresTableBody").append(`
                        <tr>
                            <td colspan="6" class="text-center text-muted">No hay colaboradores activos</td>
                        </tr>
                    `);
                } else {
                    // Llenar la tabla con los datos
                    $.each(colaboradores, function (index, colaborador) {
                        $("#colaboradoresTableBody").append(`
                            <tr>
                                <td><img src="${colaborador.foto}" width="50" height="50" class="rounded-circle" onerror="this.src='/img/default-avatar.png'" /></td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="dropdownMenu${colaborador.empleadoID}" data-bs-toggle="dropdown" aria-expanded="false">
                                            Acciones
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="dropdownMenu${colaborador.empleadoID}">
                                            <li><a class="dropdown-item" href="@Url.Action("FichaEmpleado", "Empleador")?empleadoID=${colaborador.empleadoID}">
                                                <i class="bi bi-person-circle"></i> Ver Perfil
                                            </a></li>
                                        </ul>
                                    </div>
                                </td>
                                <td>${new Date(colaborador.fechaInicio).toLocaleDateString('es-DO')}</td>
                                <td>${colaborador.identificacion}</td>
                                <td>${colaborador.Nombre}</td>
                                <td>RD$ ${colaborador.salario}</td>
                            </tr>
                        `);
                    });
                }
            },
            complete: function () {
                $("#loadingRow").hide();
            },
            error: function () {
                $("#colaboradoresTableBody").empty().append(`
                    <tr>
                        <td colspan="6" class="text-center text-danger">Error al cargar los datos.</td>
                    </tr>
                `);
                $("#loadingRow").hide();
            }
        });
    }

    // ========== FUNCIONES PARA EMPLEADOS FIJOS INACTIVOS ==========
    function loadColaboradoresInactivos(pageIndex, searchTerm) {
        $("#loadingRow2").show();
        
        $.ajax({
            type: "POST",
            url: "@Url.Action("GetColaboradoresInactivos", "Empleador")",
            data: JSON.stringify({ 
                pageIndex: pageIndex, 
                pageSize: pageSize, 
                searchTerm: searchTerm 
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                var colaboradores = response.colaboradoresInactivos;
                var totalRecords = response.totalRecords;

                // Limpiar la tabla
                $("#colaboradoresInactivosTableBody").empty();

                if (colaboradores.length === 0) {
                    $("#colaboradoresInactivosTableBody").append(`
                        <tr>
                            <td colspan="7" class="text-center text-muted">No hay colaboradores inactivos</td>
                        </tr>
                    `);
                } else {
                    $.each(colaboradores, function (index, colaborador) {
                        $("#colaboradoresInactivosTableBody").append(`
                            <tr>
                                <td><img src="${colaborador.foto}" width="50" height="50" class="rounded-circle" onerror="this.src='/img/default-avatar.png'" /></td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="dropdownMenu${colaborador.empleadoID}" data-bs-toggle="dropdown" aria-expanded="false">
                                            Acciones
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="dropdownMenu${colaborador.empleadoID}">
                                            <li><a class="dropdown-item" href="@Url.Action("FichaEmpleado", "Empleador")?empleadoID=${colaborador.empleadoID}">
                                                <i class="bi bi-person-circle"></i> Ver Perfil
                                            </a></li>
                                        </ul>
                                    </div>
                                </td>
                                <td>${colaborador.fechaInicio}</td>
                                <td>${colaborador.fechaSalida}</td>
                                <td>${colaborador.identificacion}</td>
                                <td>${colaborador.Nombre}</td>
                                <td>RD$ ${colaborador.salario}</td>
                            </tr>
                        `);
                    });
                }
            },
            complete: function () {
                $("#loadingRow2").hide();
            },
            error: function () {
                $("#colaboradoresInactivosTableBody").empty().append(`
                    <tr>
                        <td colspan="7" class="text-center text-danger">Error al cargar los datos.</td>
                    </tr>
                `);
                $("#loadingRow2").hide();
            }
        });
    }

    // ========== FUNCIONES PARA CONTRATACIONES TEMPORALES ACTIVAS ==========
    function loadContratacionesTemporales(pageIndex, searchTerm, estatus) {
        var loadingRowId = estatus === 1 ? "#loadingRow3" : "#loadingRow4";
        var tableBodyId = estatus === 1 ? "#colaboradoresTempTableBody" : "#colaboradoresTempHTableBody";
        
        $(loadingRowId).show();
        
        $.ajax({
            type: "POST",
            url: "@Url.Action("GetContratacionesTemporales", "Empleador")",
            data: JSON.stringify({ 
                pageIndex: pageIndex, 
                pageSize: pageSize, 
                searchTerm: searchTerm,
                estatus: estatus
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                var contrataciones = response.contratacionesTemporales;
                var totalRecords = response.totalRecords;

                // Limpiar la tabla
                $(tableBodyId).empty();

                if (contrataciones.length === 0) {
                    $(tableBodyId).append(`
                        <tr>
                            <td colspan="7" class="text-center text-muted">No hay contrataciones temporales</td>
                        </tr>
                    `);
                } else {
                    $.each(contrataciones, function (index, contratacion) {
                        $(tableBodyId).append(`
                            <tr>
                                <td><img src="${contratacion.foto}" width="50" height="50" class="rounded-circle" onerror="this.src='/img/default-avatar.png'" /></td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="dropdownMenu${contratacion.contratacionID}" data-bs-toggle="dropdown" aria-expanded="false">
                                            Acciones
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="dropdownMenu${contratacion.contratacionID}">
                                            <li><a class="dropdown-item" href="@Url.Action("FichaColaboradorTemporal", "Empleador")?estatus=${estatus}&contratacionID=${contratacion.contratacionID}">
                                                <i class="bi bi-person-circle"></i> Ver Perfil
                                            </a></li>
                                        </ul>
                                    </div>
                                </td>
                                <td>${contratacion.fechaRegistro}</td>
                                <td>${contratacion.Nombre}</td>
                                <td>${contratacion.identificacion}</td>
                                <td>${contratacion.telefono1}</td>
                                <td>${contratacion.telefono2}</td>
                            </tr>
                        `);
                    });
                }
            },
            complete: function () {
                $(loadingRowId).hide();
            },
            error: function () {
                $(tableBodyId).empty().append(`
                    <tr>
                        <td colspan="7" class="text-center text-danger">Error al cargar los datos.</td>
                    </tr>
                `);
                $(loadingRowId).hide();
            }
        });
    }

    // ========== EVENTOS DE BÚSQUEDA ==========
    $("#search").on("input", function () {
        loadColaboradores(1, $(this).val());
    });

    $("#search2").on("input", function () {
        loadColaboradoresInactivos(1, $(this).val());
    });

    $("#search3").on("input", function () {
        loadContratacionesTemporales(1, $(this).val(), 1);
    });

    $("#search4").on("input", function () {
        loadContratacionesTemporales(1, $(this).val(), 2);
    });

    // ========== EVENTO MODAL: SELECCIÓN DE TIPO DE COLABORADOR ==========
    $("#btnComenzar").on("click", function () {
        var tipoColaborador = $("#selectTipoColaborador").val();
        
        if (tipoColaborador === "1") {
            // Redirigir a FichaEmpleado para crear empleado fijo
            window.location.href = "@Url.Action("FichaEmpleado", "Empleador")";
        } else {
            // Redirigir a FichaColaboradorTemporal para crear contratista temporal
            window.location.href = "@Url.Action("FichaColaboradorTemporal", "Empleador")";
        }
    });

    // ========== CARGAR DATOS INICIALES ==========
    loadColaboradores(pageIndex, "");
    loadColaboradoresInactivos(pageIndex, "");
    loadContratacionesTemporales(pageIndex, "", 1); // Activas
    loadContratacionesTemporales(pageIndex, "", 2); // Historial
});
</script>
}
