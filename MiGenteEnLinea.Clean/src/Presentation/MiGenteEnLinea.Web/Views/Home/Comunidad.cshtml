@model MiGenteEnLinea.Web.Controllers.HomeController.ComunidadViewModel
@{
    ViewData["Title"] = "Comunidad";
    Layout = "_Layout";
}

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Maven+Pro&display=swap');

    body {
        font-family: 'Maven Pro', sans-serif;
        background-color: #eee;
    }

    .add {
        border-radius: 20px;
    }

    .card {
        border: none;
        border-radius: 10px;
        transition: all 1s;
        cursor: pointer;
    }

        .card:hover {
            box-shadow: 3px 5px 17px -4px #777777;
        }

    .ratings i {
        color: green;
    }

    .star {
        font-size: 20px;
        color: #ccc;
        margin-right: 5px;
    }

        .star.filled {
            color: yellow;
        }

    .avatar {
        border-radius: 50%;
        width: 150px;
        height: 150px;
        object-fit: cover;
    }

    .profile-image {
        border-radius: 50%;
        width: 150px;
        height: 150px;
        object-fit: cover;
        margin: 0 auto;
        display: block;
    }

    /* Estilo para el overlay */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

        .overlay img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 10px;
        }
</style>

<div class="justify-content-center mb-5 text-center" style="margin-top:-200px">
    <h4 class="text-white" style="font-weight:bold" id="tituloBuscador">@Model.TituloBuscador</h4>
    <label class="text-white">Apóyate de una comunidad de profesionales certificados</label>
</div>

<div class="row col col-md-12 col-12 justify-content-center" style="padding-block:40px;">
    <div class="row col col-md-10 col-12 bg-white" style="box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); padding-block:40px;margin-top:-30px; border-radius:10px">
        <h5 style="color:darkgrey; font-weight:bold">Criterio de Búsqueda</h5>
        <form method="get" asp-action="Comunidad">
            <div class="row">
                <div class="col col-md-7 col-12">
                    <label for="criterio">Criterio</label>
                    <input type="text" class="form-control" id="criterio" name="criterio" value="@Model.Criterio" placeholder="Ingrese un Texto de Referencia" />
                </div>
                <div class="col col-md-4 col-12">
                    <label for="ubicacion">Ubicación</label>
                    <select class="form-control" id="ubicacion" name="ubicacion">
                        <option value="">Seleccione la Ubicación</option>
                        @if (ViewBag.Provincias != null)
                        {
                            foreach (var provincia in ViewBag.Provincias)
                            {
                                <option value="@provincia.ProvinciaID" selected="@(provincia.ProvinciaID.ToString() == Model.Ubicacion)">@provincia.Nombre</option>
                            }
                        }
                    </select>
                </div>
                <div class="col col-md-1 col-12 align-content-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="row mt-3">
    <h5>Últimas Publicaciones</h5>
    <p>Encuentra lo que buscas gracias a nuestra comunidad de profesionales calificados</p>
    <hr class="mt-3"/>

    <div class="row col col-md-12 col-sm-12">
        @if (Model.Contratistas != null && Model.Contratistas.Any())
        {
            @foreach (var contratista in Model.Contratistas)
            {
                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="card p-3 text-center h-100 shadow-sm">
                        <!-- Imagen circular -->
                        <div class="img mb-3 d-flex justify-content-center align-items-center" style="width: 120px; height: 120px; overflow: hidden; border-radius: 50%; margin: 0 auto;">
                            <img src="@contratista.ImagenURL" class="img-fluid" alt="Imagen de @contratista.Nombre" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>

                        <!-- Nombre del profesional -->
                        <h5 class="mb-1 fw-bold text-truncate">@contratista.Nombre</h5>
                        <!-- Título -->
                        <p class="text-muted mb-2">@contratista.Titulo</p>

                        <!-- Calificación y registros -->
                        <div class="ratings mt-2" title="Perfil calificado: @contratista.TotalRegistros veces">
                            @Html.Raw(contratista.GetStarsHtml())
                            <small class="text-muted ms-1">(@contratista.TotalRegistros)</small>
                        </div>

                        <!-- Botón para ver el perfil -->
                        <div class="mt-4">
                            <button type="button" class="btn btn-success btn-sm text-uppercase" onclick="verPerfil('@contratista.UserID')">
                                Ver Perfil
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12 text-center py-5">
                <i class="bi bi-inbox" style="font-size: 48px; color: #ccc;"></i>
                <p class="text-muted mt-3">No se encontraron contratistas</p>
            </div>
        }
    </div>
</div>

<!-- Modal de Perfil Contratista -->
<div class="modal fade" id="modalPerfil" tabindex="-1" aria-labelledby="modalPerfilLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <!-- Encabezado del modal -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalPerfilLabel">Perfil Profesional</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <!-- Cuerpo del modal -->
            <div class="modal-body">
                <!-- Información principal -->
                <div class="text-center" style="padding-block:10px; background-size:cover; background-image:url('~/images/bgprofile.jpg')">
                    <div class="rounded-circle overflow-hidden mb-3" style="width: 120px; height: 120px; margin: 0 auto;">
                        <img src="#" id="imgProfile2" alt="Imagen de Perfil" class="img-fluid" style="object-fit: cover;">
                    </div>
                    <h5 class="fw-bold text-white" id="nombrePerfil">Nombre</h5>
                    <div class="rating mt-2 text-white" id="ratingContainer">
                        <span id="starsContainer"></span>
                        <span class="ms-2 text-white" id="calificacionText">0.0</span>
                    </div>
                    <p class="mt-3 text-white" id="presentacion">Presentación de ejemplo</p>
                </div>

                <!-- Navegación por pestañas -->
                <ul class="nav nav-tabs mt-4" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="datosGenerales-tab" data-bs-toggle="tab" 
                                data-bs-target="#datosGenerales" type="button" role="tab" 
                                aria-controls="datosGenerales" aria-selected="true">Datos Generales</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="servicios-tab" data-bs-toggle="tab" 
                                data-bs-target="#servicios" type="button" role="tab" 
                                aria-controls="servicios" aria-selected="false">Catálogo de Servicios</button>
                    </li>
                </ul>

                <!-- Contenido de las pestañas -->
                <div class="tab-content mt-3">
                    <!-- Pestaña de Datos Generales -->
                    <div class="tab-pane fade show active" id="datosGenerales" role="tabpanel" aria-labelledby="datosGenerales-tab">
                        <div class="row">
                            <!-- Columna izquierda -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <strong class="form-label">Título de Perfil:</strong>
                                    <p id="titulo">Título de ejemplo</p>
                                </div>
                                <div class="mb-3">
                                    <strong class="form-label">Email:</strong>
                                    <p id="email">correo@example.com</p>
                                </div>
                                <div class="mb-3">
                                    <strong class="form-label">Años de Experiencia:</strong>
                                    <p id="experiencia">5 años</p>
                                </div>
                            </div>

                            <!-- Columna derecha -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <strong class="form-label">Teléfono 1:</strong>
                                    <div id="telefono1Container">
                                        <a id="enlaceWhatsapp1" href="#" class="text-decoration-none d-none">
                                            <img src="~/images/whatsapp.png" alt="WhatsApp" width="24" height="24" class="me-2" />
                                        </a>
                                        <a id="enlaceTelefono1" href="#" style="display: block; color: black">
                                            <span id="telefono1">(000)-000-0000</span>
                                        </a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <strong class="form-label">Teléfono 2:</strong>
                                    <div id="telefono2Container">
                                        <a id="enlaceWhatsapp2" href="#" class="text-decoration-none d-none">
                                            <img src="~/images/whatsapp.png" alt="WhatsApp" width="24" height="24" class="me-2" />
                                        </a>
                                        <a id="enlaceTelefono2" href="#" style="display: block; color: black">
                                            <span id="telefono2">(000)-000-0000</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña de Catálogo de Servicios -->
                    <div class="tab-pane fade" id="servicios" role="tabpanel" aria-labelledby="servicios-tab">
                        <div class="table-responsive mt-3">
                            <table class="table table-striped table-bordered" id="tablaServicios">
                                <thead>
                                    <tr>
                                        <th>Detalle del Servicio</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se llena dinámicamente con JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pie del modal -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    async function verPerfil(userId) {
        try {
            const response = await fetch(`@Url.Action("PerfilContratista", "Home")?id=${userId}`);
            if (!response.ok) {
                throw new Error('Error al cargar el perfil');
            }

            const perfil = await response.json();

            // Llenar datos del modal
            document.getElementById('imgProfile2').src = perfil.imagenURL || 'https://via.placeholder.com/150';
            document.getElementById('nombrePerfil').textContent = perfil.tipo === 1 
                ? `${perfil.nombre} ${perfil.apellido}` 
                : (perfil.razonSocial || perfil.nombre);
            document.getElementById('presentacion').textContent = perfil.presentacion || 'Sin presentación';
            document.getElementById('titulo').textContent = perfil.titulo || 'Sin título';
            document.getElementById('email').textContent = perfil.email || 'Sin email';
            document.getElementById('experiencia').textContent = `${perfil.experiencia || 0} años`;

            // Estrellas de calificación
            const starsHtml = getStarsHtml(perfil.calificacion);
            document.getElementById('starsContainer').innerHTML = starsHtml;
            document.getElementById('calificacionText').textContent = perfil.calificacion.toFixed(1);

            // Teléfonos y WhatsApp
            const telefono1 = perfil.telefono1 || '(000)-000-0000';
            const telefono2 = perfil.telefono2 || '(000)-000-0000';
            document.getElementById('telefono1').textContent = telefono1;
            document.getElementById('telefono2').textContent = telefono2;
            document.getElementById('enlaceTelefono1').href = `tel:+${telefono1}`;
            document.getElementById('enlaceTelefono2').href = `tel:+${telefono2}`;

            if (perfil.whatsapp1) {
                const whatsappLink1 = document.getElementById('enlaceWhatsapp1');
                whatsappLink1.href = `https://api.whatsapp.com/send?phone=${telefono1}&text=Hola ${perfil.nombre}. Encontré tu contacto en la comunidad de Mi Gente En Línea, me gustaría conversar sobre tus servicios profesionales`;
                whatsappLink1.classList.remove('d-none');
            } else {
                document.getElementById('enlaceWhatsapp1').classList.add('d-none');
            }

            if (perfil.whatsapp2) {
                const whatsappLink2 = document.getElementById('enlaceWhatsapp2');
                whatsappLink2.href = `https://api.whatsapp.com/send?phone=${telefono2}&text=Hola ${perfil.nombre}. Encontré tu contacto en la comunidad de Mi Gente En Línea, me gustaría conversar sobre tus servicios profesionales`;
                whatsappLink2.classList.remove('d-none');
            } else {
                document.getElementById('enlaceWhatsapp2').classList.add('d-none');
            }

            // Llenar tabla de servicios
            const tbody = document.querySelector('#tablaServicios tbody');
            tbody.innerHTML = '';
            if (perfil.servicios && perfil.servicios.length > 0) {
                perfil.servicios.forEach(servicio => {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${servicio.detalleServicio}</td>`;
                });
            } else {
                tbody.innerHTML = '<tr><td class="text-center text-muted">No hay servicios registrados</td></tr>';
            }

            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalPerfil'));
            modal.show();

        } catch (error) {
            console.error('Error:', error);
            Swal.fire('Error', 'No se pudo cargar el perfil del contratista', 'error');
        }
    }

    function getStarsHtml(calificacion) {
        let starsHtml = '';
        const estrellasLlenas = Math.floor(calificacion);
        const tieneMedia = (calificacion - estrellasLlenas) >= 0.5;

        for (let i = 1; i <= 5; i++) {
            if (i <= estrellasLlenas) {
                starsHtml += '<i class="bi bi-star-fill" style="color:yellow"></i>';
            } else if (i === estrellasLlenas + 1 && tieneMedia) {
                starsHtml += '<i class="bi bi-star-half" style="color:yellow"></i>';
            } else {
                starsHtml += '<i class="bi bi-star" style="color:white"></i>';
            }
        }

        return starsHtml;
    }
</script>
}
