@model MiGenteEnLinea.Web.Controllers.ContratistaController.AdquirirPlanViewModel
@{
    ViewData["Title"] = "Adquirir Plan de Exposición";
    Layout = "~/Views/Shared/_LayoutContratista.cshtml";
}

@section Styles {
    <style>
        body {
            background-color: #f8f9fa;
        }

        .hero-section {
            background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
            color: white;
            padding: 60px 20px;
            margin-bottom: 50px;
            border-radius: 15px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
        }

        .hero-section h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .hero-section p {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        .pricing-card {
            border: none;
            border-radius: 15px;
            background-color: #ffffff;
            color: #212529;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
            overflow: hidden;
        }

        .pricing-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
        }

        .pricing-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .pricing-header h4 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .pricing-price {
            font-size: 3rem;
            font-weight: 800;
            margin: 15px 0 5px 0;
        }

        .pricing-period {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .pricing-body {
            padding: 30px 20px;
        }

        .pricing-features {
            list-style: none;
            padding: 0;
            margin: 0 0 30px 0;
        }

        .pricing-features li {
            padding: 12px 0;
            border-bottom: 1px solid #f1f1f1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pricing-features li:last-child {
            border-bottom: none;
        }

        .pricing-features li i {
            color: #28a745;
            font-size: 1.2rem;
        }

        .price-btn {
            background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
            border: none;
            color: white;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .price-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(13, 110, 253, 0.4);
            color: white;
        }

        .feature-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-left: auto;
        }

        .modal-header.payment-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .cardnet-logo {
            max-width: 200px;
            margin: 20px auto;
            display: block;
        }

        .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .btn-pay {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
        }

        .btn-pay:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            color: white;
        }
    </style>
}

<div class="container mt-4">
    <!-- Page Title -->
    <div class="pagetitle mb-4">
        <h1>Gestión de Planes</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Inicio</a></li>
                <li class="breadcrumb-item active">Adquirir un Plan</li>
            </ol>
        </nav>
    </div>

    <!-- Hero Section -->
    <div class="hero-section text-center">
        <h2>Plan de Exposición Profesional</h2>
        <p>Accede a los beneficios que Mi Gente en Línea ofrece adquiriendo el plan que tenemos para ti.</p>
    </div>

    <!-- Pricing Plans -->
    <section id="pricing">
        <div class="row g-4 justify-content-center">
            @if (Model.Planes != null && Model.Planes.Any())
            {
                foreach (var plan in Model.Planes)
                {
                    <div class="col-lg-6 col-md-8 col-sm-12">
                        <div class="card pricing-card">
                            <div class="pricing-header">
                                <h4>@plan.Nombre</h4>
                                <div class="pricing-price">
                                    RD$@plan.Precio.ToString("N2")
                                </div>
                                <div class="pricing-period">/Anual</div>
                            </div>

                            <div class="pricing-body">
                                <ul class="pricing-features">
                                    @foreach (var caracteristica in plan.Caracteristicas)
                                    {
                                        <li>
                                            <i class="fas fa-check-circle"></i>
                                            <span>@caracteristica</span>
                                        </li>
                                    }
                                </ul>

                                <button type="button" 
                                        class="btn price-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#checkoutModal"
                                        data-plan-id="@plan.PlanID"
                                        data-plan-nombre="@plan.Nombre"
                                        data-plan-precio="@plan.Precio">
                                    <i class="fas fa-shopping-cart me-2"></i>Adquirir Plan
                                </button>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        No hay planes disponibles en este momento. Por favor, contacte al administrador.
                    </div>
                </div>
            }
        </div>
    </section>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header payment-header">
                <h5 class="modal-title" id="checkoutModalLabel">
                    <i class="fas fa-credit-card me-2"></i>Pago con Tarjeta de Crédito
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <img src="https://gcs-international.com/wp-content/uploads/2017/06/Cardnet-Web.png" 
                         alt="Cardnet" 
                         class="cardnet-logo" />
                </div>

                <form id="paymentForm">
                    <input type="hidden" id="planID" name="planID" />
                    <input type="hidden" id="planNombre" name="planNombre" />
                    <input type="hidden" id="planPrecio" name="planPrecio" />

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="cardNumber" class="form-label">
                                <i class="fas fa-credit-card me-2"></i>Número de Tarjeta *
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="cardNumber" 
                                   name="cardNumber" 
                                   placeholder="1234 5678 9012 3456" 
                                   maxlength="19"
                                   required />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="cardHolderName" class="form-label">
                                <i class="fas fa-user me-2"></i>Nombre del Titular *
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="cardHolderName" 
                                   name="cardHolderName" 
                                   placeholder="Como aparece en la tarjeta" 
                                   required />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="expiryDate" class="form-label">
                                <i class="fas fa-calendar-alt me-2"></i>Fecha de Vencimiento *
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="expiryDate" 
                                   name="expiryDate" 
                                   placeholder="MM/AA" 
                                   maxlength="5"
                                   required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cvv" class="form-label">
                                <i class="fas fa-lock me-2"></i>CVV *
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="cvv" 
                                   name="cvv" 
                                   placeholder="123" 
                                   maxlength="4"
                                   required />
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-shield-alt me-2"></i>
                        Tus datos están seguros. Utilizamos encriptación SSL y cumplimos con los estándares PCI DSS.
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Resumen de Compra</h6>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Plan:</span>
                                        <strong id="resumenPlan">-</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Duración:</span>
                                        <strong>12 meses</strong>
                                    </div>
                                    <hr />
                                    <div class="d-flex justify-content-between">
                                        <span class="h5">Total a Pagar:</span>
                                        <strong class="h5 text-success" id="resumenTotal">RD$0.00</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-pay" id="btnProcesarPago">
                    <i class="fas fa-check me-2"></i>Procesar Pago
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        $(document).ready(function () {
            // When modal opens, populate plan data
            $('#checkoutModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);
                const planID = button.data('plan-id');
                const planNombre = button.data('plan-nombre');
                const planPrecio = button.data('plan-precio');

                $('#planID').val(planID);
                $('#planNombre').val(planNombre);
                $('#planPrecio').val(planPrecio);

                $('#resumenPlan').text(planNombre);
                $('#resumenTotal').text('RD$' + parseFloat(planPrecio).toFixed(2));
            });

            // Card number formatting
            $('#cardNumber').on('input', function () {
                let value = $(this).val().replace(/\s/g, '');
                let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
                $(this).val(formatted);
            });

            // Expiry date formatting
            $('#expiryDate').on('input', function () {
                let value = $(this).val().replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                $(this).val(value);
            });

            // CVV - only numbers
            $('#cvv').on('input', function () {
                $(this).val($(this).val().replace(/\D/g, ''));
            });

            // Process payment
            $('#btnProcesarPago').on('click', function () {
                procesarPago();
            });
        });

        function procesarPago() {
            // Validate form
            const form = $('#paymentForm')[0];
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const paymentData = {
                planID: parseInt($('#planID').val()),
                cardNumber: $('#cardNumber').val().replace(/\s/g, ''),
                cardHolderName: $('#cardHolderName').val(),
                expiryDate: $('#expiryDate').val(),
                cvv: $('#cvv').val()
            };

            // Show loading
            Swal.fire({
                title: 'Procesando Pago',
                html: 'Por favor espere mientras procesamos su transacción...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            $.ajax({
                url: '@Url.Action("ProcesarPago", "Contratista")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(paymentData),
                success: function (response) {
                    Swal.close();

                    if (response.success) {
                        Swal.fire({
                            title: '¡Pago Exitoso!',
                            html: `
                                <p>Tu suscripción ha sido activada correctamente.</p>
                                <p><strong>ID de Transacción:</strong> ${response.transactionId}</p>
                                <p>Ahora puedes disfrutar de todos los beneficios de tu plan.</p>
                            `,
                            icon: 'success',
                            confirmButtonText: 'Continuar'
                        }).then(() => {
                            window.location.href = '@Url.Action("Index", "Contratista")';
                        });
                    } else {
                        Swal.fire({
                            title: 'Error en el Pago',
                            text: response.message || 'No se pudo procesar el pago. Verifique sus datos e intente nuevamente.',
                            icon: 'error'
                        });
                    }
                },
                error: function (xhr, status, error) {
                    Swal.close();
                    Swal.fire({
                        title: 'Error',
                        text: 'Ocurrió un error al procesar el pago. Por favor, intente nuevamente más tarde.',
                        icon: 'error'
                    });
                }
            });
        }
    </script>
}
