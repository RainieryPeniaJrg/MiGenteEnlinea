# üöÄ Script de Setup para Migraci√≥n a Code-First
# Este script automatiza la creaci√≥n de la nueva soluci√≥n Clean Architecture

param(
    [string]$SolutionPath = "C:\Users\ray\OneDrive\Documents\ProyectoMigente\MiGenteEnLinea.Clean",
    [string]$DbServer = ".",
    [string]$DbName = "migenteV2",
    [string]$DbUser = "sa",
    [string]$DbPassword = "1234"
)

Write-Host "üîÑ Iniciando Setup de Migraci√≥n a Code-First..." -ForegroundColor Cyan
Write-Host ""

# Verificar que dotnet est√° instalado
Write-Host "‚úì Verificando .NET SDK..." -ForegroundColor Yellow
$dotnetVersion = dotnet --version
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Error: .NET SDK no est√° instalado" -ForegroundColor Red
    exit 1
}
Write-Host "  .NET SDK version: $dotnetVersion" -ForegroundColor Green
Write-Host ""

# Crear directorio de soluci√≥n
Write-Host "üìÅ Creando estructura de directorios..." -ForegroundColor Yellow
if (-not (Test-Path $SolutionPath)) {
    New-Item -ItemType Directory -Path $SolutionPath | Out-Null
    Write-Host "  ‚úì Directorio creado: $SolutionPath" -ForegroundColor Green
} else {
    Write-Host "  ‚ö† Directorio ya existe: $SolutionPath" -ForegroundColor Yellow
}
Set-Location $SolutionPath
Write-Host ""

# Crear soluci√≥n
Write-Host "üèóÔ∏è  Creando soluci√≥n..." -ForegroundColor Yellow
dotnet new sln -n MiGenteEnLinea.Clean -o . --force
Write-Host "  ‚úì Soluci√≥n creada" -ForegroundColor Green
Write-Host ""

# Crear proyectos
Write-Host "üì¶ Creando proyectos..." -ForegroundColor Yellow

Write-Host "  ‚Ä¢ Domain (Core/Entities/ValueObjects)..." -ForegroundColor Cyan
dotnet new classlib -n MiGenteEnLinea.Domain -f net8.0 -o src/Core/MiGenteEnLinea.Domain
dotnet sln add src/Core/MiGenteEnLinea.Domain/MiGenteEnLinea.Domain.csproj

Write-Host "  ‚Ä¢ Application (UseCases/DTOs/Validators)..." -ForegroundColor Cyan
dotnet new classlib -n MiGenteEnLinea.Application -f net8.0 -o src/Core/MiGenteEnLinea.Application
dotnet sln add src/Core/MiGenteEnLinea.Application/MiGenteEnLinea.Application.csproj

Write-Host "  ‚Ä¢ Infrastructure (EF Core/Identity/Services)..." -ForegroundColor Cyan
dotnet new classlib -n MiGenteEnLinea.Infrastructure -f net8.0 -o src/Infrastructure/MiGenteEnLinea.Infrastructure
dotnet sln add src/Infrastructure/MiGenteEnLinea.Infrastructure/MiGenteEnLinea.Infrastructure.csproj

Write-Host "  ‚Ä¢ API (Controllers/Middleware)..." -ForegroundColor Cyan
dotnet new webapi -n MiGenteEnLinea.API -f net8.0 -o src/Presentation/MiGenteEnLinea.API --use-controllers
dotnet sln add src/Presentation/MiGenteEnLinea.API/MiGenteEnLinea.API.csproj

Write-Host "  ‚úì Proyectos creados" -ForegroundColor Green
Write-Host ""

# Configurar referencias entre proyectos
Write-Host "üîó Configurando referencias entre proyectos..." -ForegroundColor Yellow
dotnet add src/Core/MiGenteEnLinea.Application/MiGenteEnLinea.Application.csproj reference src/Core/MiGenteEnLinea.Domain/MiGenteEnLinea.Domain.csproj
dotnet add src/Infrastructure/MiGenteEnLinea.Infrastructure/MiGenteEnLinea.Infrastructure.csproj reference src/Core/MiGenteEnLinea.Application/MiGenteEnLinea.Application.csproj
dotnet add src/Presentation/MiGenteEnLinea.API/MiGenteEnLinea.API.csproj reference src/Core/MiGenteEnLinea.Application/MiGenteEnLinea.Application.csproj
dotnet add src/Presentation/MiGenteEnLinea.API/MiGenteEnLinea.API.csproj reference src/Infrastructure/MiGenteEnLinea.Infrastructure/MiGenteEnLinea.Infrastructure.csproj
Write-Host "  ‚úì Referencias configuradas" -ForegroundColor Green
Write-Host ""

# Instalar paquetes NuGet
Write-Host "üì¶ Instalando paquetes NuGet..." -ForegroundColor Yellow

Write-Host "  ‚Ä¢ Domain packages..." -ForegroundColor Cyan
dotnet add src/Core/MiGenteEnLinea.Domain/MiGenteEnLinea.Domain.csproj package FluentValidation --version 11.9.0

Write-Host "  ‚Ä¢ Application packages..." -ForegroundColor Cyan
dotnet add src/Core/MiGenteEnLinea.Application/MiGenteEnLinea.Application.csproj package MediatR --version 12.2.0
dotnet add src/Core/MiGenteEnLinea.Application/MiGenteEnLinea.Application.csproj package AutoMapper --version 12.0.1
dotnet add src/Core/MiGenteEnLinea.Application/MiGenteEnLinea.Application.csproj package FluentValidation.DependencyInjectionExtensions --version 11.9.0

Write-Host "  ‚Ä¢ Infrastructure packages..." -ForegroundColor Cyan
dotnet add src/Infrastructure/MiGenteEnLinea.Infrastructure/MiGenteEnLinea.Infrastructure.csproj package Microsoft.EntityFrameworkCore.SqlServer --version 8.0.0
dotnet add src/Infrastructure/MiGenteEnLinea.Infrastructure/MiGenteEnLinea.Infrastructure.csproj package Microsoft.EntityFrameworkCore.Tools --version 8.0.0
dotnet add src/Infrastructure/MiGenteEnLinea.Infrastructure/MiGenteEnLinea.Infrastructure.csproj package Microsoft.EntityFrameworkCore.Design --version 8.0.0
dotnet add src/Infrastructure/MiGenteEnLinea.Infrastructure/MiGenteEnLinea.Infrastructure.csproj package BCrypt.Net-Next --version 4.0.3
dotnet add src/Infrastructure/MiGenteEnLinea.Infrastructure/MiGenteEnLinea.Infrastructure.csproj package Serilog.AspNetCore --version 8.0.0
dotnet add src/Infrastructure/MiGenteEnLinea.Infrastructure/MiGenteEnLinea.Infrastructure.csproj package Serilog.Sinks.MSSqlServer --version 6.5.0

Write-Host "  ‚Ä¢ API packages..." -ForegroundColor Cyan
dotnet add src/Presentation/MiGenteEnLinea.API/MiGenteEnLinea.API.csproj package Microsoft.AspNetCore.Authentication.JwtBearer --version 8.0.0
dotnet add src/Presentation/MiGenteEnLinea.API/MiGenteEnLinea.API.csproj package AspNetCoreRateLimit --version 5.0.0
dotnet add src/Presentation/MiGenteEnLinea.API/MiGenteEnLinea.API.csproj package Swashbuckle.AspNetCore --version 6.5.0

Write-Host "  ‚úì Paquetes instalados" -ForegroundColor Green
Write-Host ""

# Instalar EF Core Tools global
Write-Host "üîß Instalando Entity Framework Core Tools..." -ForegroundColor Yellow
dotnet tool install --global dotnet-ef --version 8.0.0
if ($LASTEXITCODE -eq 0) {
    Write-Host "  ‚úì dotnet-ef instalado globalmente" -ForegroundColor Green
} else {
    Write-Host "  ‚ö† dotnet-ef ya est√° instalado o hubo un error (puedes ignorar esto)" -ForegroundColor Yellow
}
Write-Host ""

# Crear estructura de carpetas en Domain
Write-Host "üìÅ Creando estructura de carpetas en Domain..." -ForegroundColor Yellow
$domainFolders = @(
    "src/Core/MiGenteEnLinea.Domain/Entities",
    "src/Core/MiGenteEnLinea.Domain/Entities/Authentication",
    "src/Core/MiGenteEnLinea.Domain/Entities/Empleadores",
    "src/Core/MiGenteEnLinea.Domain/Entities/Contratistas",
    "src/Core/MiGenteEnLinea.Domain/Entities/Nomina",
    "src/Core/MiGenteEnLinea.Domain/Entities/Contrataciones",
    "src/Core/MiGenteEnLinea.Domain/Entities/Calificaciones",
    "src/Core/MiGenteEnLinea.Domain/Entities/Suscripciones",
    "src/Core/MiGenteEnLinea.Domain/Entities/Pagos",
    "src/Core/MiGenteEnLinea.Domain/Entities/Catalogos",
    "src/Core/MiGenteEnLinea.Domain/ValueObjects",
    "src/Core/MiGenteEnLinea.Domain/Enums",
    "src/Core/MiGenteEnLinea.Domain/Interfaces"
)

foreach ($folder in $domainFolders) {
    if (-not (Test-Path $folder)) {
        New-Item -ItemType Directory -Path $folder -Force | Out-Null
    }
}
Write-Host "  ‚úì Estructura de Domain creada" -ForegroundColor Green
Write-Host ""

# Crear estructura de carpetas en Application
Write-Host "üìÅ Creando estructura de carpetas en Application..." -ForegroundColor Yellow
$appFolders = @(
    "src/Core/MiGenteEnLinea.Application/Common/Interfaces",
    "src/Core/MiGenteEnLinea.Application/Common/Behaviors",
    "src/Core/MiGenteEnLinea.Application/Common/Exceptions",
    "src/Core/MiGenteEnLinea.Application/Features/Authentication/Commands",
    "src/Core/MiGenteEnLinea.Application/Features/Authentication/Queries",
    "src/Core/MiGenteEnLinea.Application/Features/Authentication/DTOs",
    "src/Core/MiGenteEnLinea.Application/Features/Authentication/Validators",
    "src/Core/MiGenteEnLinea.Application/Features/Empleadores",
    "src/Core/MiGenteEnLinea.Application/Features/Contratistas",
    "src/Core/MiGenteEnLinea.Application/Features/Nominas",
    "src/Core/MiGenteEnLinea.Application/Features/Suscripciones"
)

foreach ($folder in $appFolders) {
    if (-not (Test-Path $folder)) {
        New-Item -ItemType Directory -Path $folder -Force | Out-Null
    }
}
Write-Host "  ‚úì Estructura de Application creada" -ForegroundColor Green
Write-Host ""

# Crear estructura de carpetas en Infrastructure
Write-Host "üìÅ Creando estructura de carpetas en Infrastructure..." -ForegroundColor Yellow
$infraFolders = @(
    "src/Infrastructure/MiGenteEnLinea.Infrastructure/Persistence/Contexts",
    "src/Infrastructure/MiGenteEnLinea.Infrastructure/Persistence/Configurations",
    "src/Infrastructure/MiGenteEnLinea.Infrastructure/Persistence/Repositories",
    "src/Infrastructure/MiGenteEnLinea.Infrastructure/Persistence/Migrations",
    "src/Infrastructure/MiGenteEnLinea.Infrastructure/Persistence/Entities/Generated",
    "src/Infrastructure/MiGenteEnLinea.Infrastructure/Identity/Services",
    "src/Infrastructure/MiGenteEnLinea.Infrastructure/Services"
)

foreach ($folder in $infraFolders) {
    if (-not (Test-Path $folder)) {
        New-Item -ItemType Directory -Path $folder -Force | Out-Null
    }
}
Write-Host "  ‚úì Estructura de Infrastructure creada" -ForegroundColor Green
Write-Host ""

# Compilar soluci√≥n
Write-Host "üî® Compilando soluci√≥n..." -ForegroundColor Yellow
dotnet build
if ($LASTEXITCODE -eq 0) {
    Write-Host "  ‚úì Soluci√≥n compilada exitosamente" -ForegroundColor Green
} else {
    Write-Host "  ‚ùå Error compilando la soluci√≥n" -ForegroundColor Red
    exit 1
}
Write-Host ""

# Preparar comando de scaffolding
Write-Host "üìù Preparando comando de scaffolding..." -ForegroundColor Yellow
$connectionString = "Server=$DbServer;Database=$DbName;User Id=$DbUser;Password=$DbPassword;TrustServerCertificate=True"
$scaffoldCommand = "dotnet ef dbcontext scaffold `"$connectionString`" Microsoft.EntityFrameworkCore.SqlServer --output-dir Persistence/Entities/Generated --context-dir Persistence/Contexts --context MiGenteDbContext --force --data-annotations --no-onconfiguring --startup-project ../../Presentation/MiGenteEnLinea.API"

Write-Host ""
Write-Host "‚úÖ Setup completado exitosamente!" -ForegroundColor Green
Write-Host ""
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Cyan
Write-Host "üìã PR√ìXIMOS PASOS:" -ForegroundColor Yellow
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Cyan
Write-Host ""
Write-Host "1Ô∏è‚É£  Ejecutar Scaffolding de Base de Datos:" -ForegroundColor Yellow
Write-Host "   cd src/Infrastructure/MiGenteEnLinea.Infrastructure" -ForegroundColor White
Write-Host "   $scaffoldCommand" -ForegroundColor Cyan
Write-Host ""
Write-Host "2Ô∏è‚É£  Revisar Entidades Generadas:" -ForegroundColor Yellow
Write-Host "   cd Persistence/Entities/Generated" -ForegroundColor White
Write-Host "   ls" -ForegroundColor White
Write-Host ""
Write-Host "3Ô∏è‚É£  Comenzar Refactoring con Credencial:" -ForegroundColor Yellow
Write-Host "   ‚Ä¢ Copiar Generated/Credenciale.cs a Domain/Entities/Authentication/Credencial.cs" -ForegroundColor White
Write-Host "   ‚Ä¢ Aplicar encapsulaci√≥n y DDD" -ForegroundColor White
Write-Host "   ‚Ä¢ Crear CredencialConfiguration en Infrastructure/Persistence/Configurations/" -ForegroundColor White
Write-Host ""
Write-Host "4Ô∏è‚É£  Consultar Gu√≠a Detallada:" -ForegroundColor Yellow
Write-Host "   docs/MIGRATION_DATABASE_FIRST_TO_CODE_FIRST.md" -ForegroundColor White
Write-Host ""
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Cyan
Write-Host ""
Write-Host "üìÇ Estructura creada en: $SolutionPath" -ForegroundColor Green
Write-Host ""
